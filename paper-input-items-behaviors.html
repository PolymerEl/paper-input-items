<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="paper-input-behaviors.html">
<script>
window.Polymer = window.Polymer || {};
Polymer.behaviors = Polymer.behaviors || {};
/* @polymerBehavior Polymer.behaviors.paperInputItemsImpl */
Polymer.behaviors.paperInputItemsImpl = {

  properties: {
    /**
     * An ordered array of data items produced by the current Firebase Query
     * instance.
     */
    items: {
      type: Array,
      notify: true,
      value: function() {
        return [];
      }
    },

    /* 
     * `valuePath` 
     */
    valuePath: {
      type: String,
      value: 'value',
      observer: '__observeValuePath'
    },

    /**
     * `valueAccessor` the function for accessing value
     */
    valueAccessor: {
      type: Function
    },

    /* 
     * `labelPath` 
     */
    labelPath: {
      type: String,
      value: 'label',
      observer: '__observeLabelPath'
    },

    /**
     * `labelAccessor` the function for accessing label
     */
    labelAccessor: {
      type: Function
    },

    /**
     * `filter` function passed to `<template is="dom-repeat">`
     */
    filter: {
      type: Function,
    },

    /* 
     * `observe` fields to be observed in dom-repeat
     */
    observe: {
      type: String,
    },

    readonly: {
      type: Boolean
    }

  },

  observers: [
    '__observeAccessor(labelAccessor, labelAccessor.changed)',
    '__observeAccessor(valueAccessor, valueAccessor.changed)'
  ],

  listeners: {
    'item-label-changed': '__onLabelChanged'
  },

  /* 
   * `__onLabelChanged` usefull when the label os a selectedItem changes. Without this function (triggered by `item-label-changed`), the visible value label does not update.  
   */
  __onLabelChanged: function(e) {
    e.stopPropagation();
    this.refresh();
  },

  //call doRefresh to refresh the label  (for instance when db lookup have not been uploaded yet)
  refresh: function() {
    this.$.selector._selectedItemChanged(this.$.selector.selectedItem);
  },

  __observeAccessor: function(changed) {
    this.debounce('observe-accessor-input-items', function() {
      this.__observeFunctionChange();
    }, 80);
  },

  __observeFunctionChange: function() {
    if (this.$.repeat) {
      this.debounce('debounceTemplate', function() {
        this.$.repeat._debounceTemplate(this.$.repeat._render);
      }, 100);
    }
  },

  __observeLabelPath: function(path, old) {
    if (path) {
      this.labelAccessor = this.__computeAccessor(path)
    }
  },

  __observeValuePath: function(path, old) {
    if (path) {
      this.valueAccessor = this.__computeAccessor(path)
    }
  },

  __computeAccessor: function(path) {
    if (path) {
      var me = this;
      return function(item) {
        item = item.base || item;
        return me.get(path, item);
      };
    }
  }

};

/* @polymerBehavior Polymer.behaviors.paperInputItems */
Polymer.behaviors.paperInputItems = [
  Polymer.behaviors.paperInput,
  Polymer.behaviors.paperInputItemsImpl
];
</script>
